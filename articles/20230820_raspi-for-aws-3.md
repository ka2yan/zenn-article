---
title: "RaspberryPiã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã¨ã¡ã‚ƒã‚“ã¨è©±ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆç¬¬ï¼“å›ï¼‰"
emoji: "ğŸ“˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["raspberrypi", "yocto", "aws", "docker"]
publication_name: "singularity"
published: true

---
çµ„è¾¼ã¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ katsu ã§ã™ã€‚

RaspberryPiã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã¨ã¡ã‚ƒã‚“ã¨è©±ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ç¬¬ï¼’å›ã§ã™ã€‚
å…¨ä½“ã®ä½ç½®ä»˜ã‘ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

# [ç¬¬ï¼‘å›](https://zenn.dev/singularity/articles/20230611_raspi-for-aws-1)
ãŠè©¦ã—ã§ã€RaspberryPiã‚’AWS IoTã¨ç¹‹ã’ã¦ã¿ã¾ã™ã€‚
AWSã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æ‰‹é †ã§ã€RaspberryPiã¨AWS IoTã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¹‹ã’ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ã‚’ã—ã¦ã¿ã¾ã™ã€‚

# [ç¬¬ï¼’å›](https://zenn.dev/singularity/articles/20230628_raspi-for-aws-2)
RaspberryPiã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
Dockerã§Ubuntuç’°å¢ƒã‚’ç«‹ã¡ä¸Šã’ã€Yoctoã¨ã„ã†ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã‚’ç”¨ã„ã¦ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
åˆã‚ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ã€ä¸€æ™©ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã€‚å¤§å¤‰ã€‚

# ç¬¬ï¼“å›ï¼ˆä»Šå›ã‚³ã‚³ï¼‰
AWS IoTã‚µãƒ¼ãƒ“ã‚¹å‘ã‘ã«å¿…è¦ãªæ©Ÿèƒ½ã‚’çµ„è¾¼ã¿ã¾ã™ã€‚
AWSãŒæä¾›ã—ã¦ã„ã‚‹AWS IoTå‘ã‘ãƒ¬ã‚·ãƒ”é›† meta-aws ã‚’Yoctoãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã§ã€AWSæ¥ç¶šã§ãã‚‹æ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

# ç¬¬ï¼”å›
RaspberryPiã¨AWS IoTã‚µãƒ¼ãƒ“ã‚¹ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ã‚’ã—ã¦ã¿ã¾ã™ã€‚
å¥½ããªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã©ã†ã‚„ã£ã¦é€ã‚‹ã®ã‹ã€AWSä¸Šã§ã©ã†ã‚„ã£ã¦å—ä¿¡ã™ã‚‹ã®ã‹ã€ã“ã‚Œã‚’è£½å“ã«ä»•ç«‹ã¦ã‚‹ã«ã¯ä½•ãŒå¿…è¦ãªã®ã‹ã€ç¢ºèªã—ã¾ã™ã€‚

# ç¬¬ï¼•å›
AWSã«æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ã‚’ã©ã†ã‚„ã£ã¦çµ„ã¿è¾¼ã‚€ã®ã‹è€ƒãˆã¾ã™ã€‚
AWSã¨æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ã¯ä½•ã‹ã€RaspberryPiã«çµ„ã¿è¾¼ã‚€ã«ã¯ã€ã©ã®ã‚ˆã†ãªæ–¹æ³•ãŒã‚ã‚‹ã®ã‹ã€è€ƒå¯Ÿã—ã¾ã™ã€‚

----
# ç¬¬3å›ï¼š  RaspberryPi ã« AWS IoT ã«å¿…è¦ãªæ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹

RaspberryPiã«AWS IoTæ¥ç¶šã«å¿…è¦ãªæ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚“ã§ã€AWS IoTã¨æ¥ç¶šã™ã‚‹ã¾ã§ã‚’ç¢ºèªã—ã¾ã™ã€‚
ä»Šå›ã¯ã€AWSã¨æ¥ç¶šã™ã‚‹éš›ã«å¿…è¦ãªè¨¼æ˜æ›¸ã‚„éµæƒ…å ±ã‚’é™çš„ã«çµ„ã¿è¾¼ã¿ã¾ã™ãŒã€
æ¬¡å›ä»¥é™ã§ã€å‹•çš„ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã«ã‚‚ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## meta-aws ã¨ã¯
meta-aws ã¨ã¯ã€AWSã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’çµ„ã¿è¾¼ã‚€ãŸã‚ã®Yoctoãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ å‘ã‘ãƒ¬ã‚·ãƒ”é›†ï¼ˆBSPãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã§ã™ã€‚æœ¬ãƒ¬ã‚·ãƒ”é›†ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€AWS IoTã¨æ¥ç¶šã™ã‚‹ã®ã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ã‚³ãƒãƒ³ãƒ‰ã‚’RaspberryPiã«çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

[meta-awså…¬å¼ãƒšãƒ¼ã‚¸](https://github.com/aws4embeddedlinux/meta-aws)

å…¬å¼ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã™ã‚‹ã¨ã€è¤‡æ•°ã®AWSå‘ã‘ã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã“ã¨ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚
æœ¬ç« ã§ã¯ã€AWS IoTã¨æ¥ç¶šã™ã‚‹ãŸã‚ã®æœ€å°ã‚»ãƒƒãƒˆã§ã‚ã‚‹
"AWS IoT Device SDK for C++ v2"ã¨ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ„ã¿è¾¼ã¿ã¾ã™ã€‚

### aws-iot-device-sdk-cpp-v2 ã¨ã¯
â€aws-iot-device-sdk-cpp-v2"ã¨ã¯ã€AWS IoT ã¨æ¥ç¶šã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢å‘ã‘ã®C++ SDKã§ã™ã€‚
Pythonç”¨SDKãªã©ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯ãƒã‚¤ãƒŠãƒªã‚µã‚¤ã‚ºãŒå°ã•ãã€é«˜é€Ÿå‹•ä½œã§ãã‚‹ï¼ˆã§ã‚ã‚ã†ï¼‰C++ SDKã‚’çµ„ã¿è¾¼ã¿ã¾ã™ã€‚
SDKè‡ªä½“ã¨ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ¬ã‚·ãƒ”ï¼ˆbbãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¯[ã“ã¡ã‚‰](https://github.com/aws4embeddedlinux/meta-aws/tree/master/recipes-sdk/aws-iot-device-sdk-cpp-v2)ã«ã‚ã‚Šã¾ã™ã€‚

## SDK ã®çµ„è¾¼ã¿
### SDKã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹
[meta-awså…¬å¼ãƒšãƒ¼ã‚¸](https://github.com/aws4embeddedlinux/meta-aws) ã® Dependencies ã«è¨˜è¼‰ã«å¾“ã£ã¦ã€OpenEmbeddedã®BSPãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ä¸€ç·’ã«çµ„ã¿è¾¼ã‚“ã§ã„ãã¾ã™ã€‚

ç’°å¢ƒæ§‹ç¯‰ã¯ã€[å‰å›ã®è¨˜äº‹](https://zenn.dev/singularity/articles/20230628_raspi-for-aws-2)ã‚’å‚ç…§ãã ã•ã„ã€‚

meta-openembedded, meta-aws ã®ï¼’ã¤ã®BSPãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ git clone ã—ã¾ã™ã€‚
```
$ cd raspi2/poky
$ git clone https://github.com/openembedded/meta-openembedded
$ git clone https://github.com/aws4embeddedlinux/meta-aws
```

â€bblayer.conf"ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€
ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã«ã€git cloneã—ãŸBSPãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```diff bash:build/conf/bblayer.conf
@ -10,4 +10,9 @@
   /home/hoge/raspi2/poky/meta-poky \
   /home/hoge/raspi2/poky/meta-yocto-bsp \
   /home/hoge/raspi2/poky/meta-raspberrypi \
+  /home/hoge/raspi2/poky/meta-openembedded/meta-oe \
+  /home/hoge/raspi2/poky/meta-openembedded/meta-multimedia \
+  /home/hoge/raspi2/poky/meta-openembedded/meta-networking \
+  /home/hoge/raspi2/poky/meta-openembedded/meta-python \
+  /home/hoge/raspi2/poky/meta-aws \
```

ç¶šã„ã¦ã€â€local.conf"ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®åç§°ã§SDKã¨ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã«åŠ ãˆã¾ã™ã€‚

|  | åç§° |
| ---- | ---- |
| SDK | aws-iot-device-sdk-cpp-v2 |
| ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ  | aws-iot-device-sdk-cpp-v2-samples-mqtt5-pubsub |

å®Ÿã¯ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã ã‘ã‚’è¿½åŠ ã—ã¦ã‚‚ã€Yoctoã§ä¾å­˜é–¢ä¿‚ã‚’è¦‹ã¦ãã‚Œã¦è‡ªå‹•çš„ã«SDKã‚‚çµ„ã¿è¾¼ã‚“ã§ãã‚Œã‚‹ã®ã§ã™ãŒã€ã“ã“ã§ã¯åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€ä¸¡æ–¹æ›¸ã„ã¦ãŠãã¾ã™ã€‚

```diff bash:build/conf/local.conf
@@ -281,3 +281,15 @@
 # track the version of this file when it was generated. This can safely be ignored if
 # this doesn't mean anything to you.
 CONF_VERSION = "2"
+
+IMAGE_INSTALL:append = " aws-iot-device-sdk-cpp-v2"
+IMAGE_INSTALL:append = " aws-iot-device-sdk-cpp-v2-samples-mqtt5-pubsub"
"
```

ã¤ã„ã§ã«ã€SSHã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
```diff bash:build/conf/local.conf
-293,3 +293,6 @@
+IMAGE_INSTALL:append = " openssh openssh-sftp-server"
```

bitbakeã‚³ãƒãƒ³ã§ã€ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
```
ï¼„ bitbake core-image-minimal
Loading cache: 100% |                                | ETA:  --:--:--
Loaded 0 entries from dependency cache.
Parsing recipes: 100% |##############################| Time: 0:01:43
Parsing of 2751 .bb files complete (0 cached, 2751 parsed). 4507 targets, 171 skipped, 0 masked, 0 errors.
NOTE: Resolving any missing task queue dependencies

Build Configuration:
BB_VERSION           = "2.4.0"
BUILD_SYS            = "aarch64-linux"
NATIVELSBSTRING      = "universal"
TARGET_SYS           = "arm-poky-linux-gnueabi"
MACHINE              = "raspberrypi2"
DISTRO               = "poky"
DISTRO_VERSION       = "4.2"
TUNE_FEATURES        = "arm vfp cortexa7 neon vfpv4 thumb callconvention-hard"
TARGET_FPU           = "hard"
meta                 
meta-poky            
meta-yocto-bsp       = "master:13b646c0e167ca52f69c91be5538049b172015ac"
meta-raspberrypi     = "master:dff85b9a9f66002856b9ed3b1aa3a384c0bc43d9"
meta-oe              
meta-multimedia      
meta-networking      
meta-python          = "master:bf314d2c57d63afd680ab21baf43e150456120ed"
meta-aws             = "master:c370b087fa54a2b2a01c8ecff6d4d05ea9d141bf"

Initialising tasks: 100% |#########################| Time: 0:00:01
Sstate summary: Wanted 427 Local 405 Mirrors 0 Missed 22 Current 1222 (94% match, 98% complete)
Removing 4 stale sstate objects for arch raspberrypi2: 100% |#####| Time: 0:00:00
NOTE: Executing Tasks
NOTE: Tasks Summary: Attempted 3792 tasks of which 3742 didn't need to be rerun and all succeeded.
```
å‰å›ã¯3408å€‹ã®ã‚¿ã‚¹ã‚¯ãŒã€ä»Šå›ã¯3792å€‹ã«å¢—ãˆã¾ã—ãŸã€‚

ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç¢ºèªã—ã¾ã™ã€‚
```
ls -l tmp/deploy/images/raspberrypi2/*.wic.bz2 
-rw-r--r-- 2 hoge hoge 26771677 Jul 17 08:26 tmp/deploy/images/raspberrypi2/core-image-minimal-raspberrypi2-20230716231341.rootfs.wic.bz2
lrwxrwxrwx 2 hoge hoge       61 Jul 17 08:26 tmp/deploy/images/raspberrypi2/core-image-minimal-raspberrypi2.wic.bz2 -> core-image-minimal-raspberrypi2-20230716231341.rootfs.wic.bz2
```
26,771,677ãƒã‚¤ãƒˆï¼ˆ26MBï¼‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒã§ãã¾ã—ãŸã€‚

### RaspberryPiã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç„¼ã
å‰å›ã¨åŒæ§˜ã€
Macå´ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ã€"docker cp" ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¨ã£ã¦ãã¾ã™ï¼ˆè§£å‡ã—ã¾ã™ï¼‰ã€‚
```
$docker ps
CONTAINER ID   IMAGE          COMMAND       CREATED       STATUS       PORTS     NAMES
b7c4cb3eeb5c   ubuntu:22.04   "/bin/bash"   3 weeks ago   Up 2 weeks             raspi2-env
$
$ docker cp b7c4cb3eeb5c:/home/hoge/raspi2/poky/build/tmp/deploy/images/raspberrypi2/core-image-minimal-raspberrypi2-20230716231341.rootfs.wic.bz2 .
$
$ bunzip2 core-image-minimal-raspberrypi2-20230716231341.rootfs.wic.bz2
```

æ›¸ãè¾¼ã¿ã«ã‚‚å‰ç« ã§ä½¿ç”¨ã—ãŸ RaspberryPi Imager ã‚’ä½¿ç”¨ã—ã¾ã—ã‚‡ã†ã€‚
RaspberryPi Imagerã‚’èµ·å‹•ã—ã¾ã™ã€‚
![](/images/20230611_010.png)

æ›¸ãè¾¼ã‚€OSã‚’é¸æŠã—ã¾ã™ã€‚
ä¸€ç•ªä¸‹ã®ã€Œã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ã€ã‹ã‚‰ã€å…ˆã»ã©ç”¨æ„ã—ãŸãƒ“ãƒ«ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é¸æŠã—ã¾ã™ã€‚
![](/images/20230628_210.png)

RaspberyPiç”¨ã®SDã‚«ãƒ¼ãƒ‰ã‚’Macã«æŒ¿ã—ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«é¸æŠã—ã¾ã™ã€‚
![](/images/20230819_010.png)

ã€Œæ›¸ãè¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ã—ã°ã‚‰ãå¾…ã£ã¦ãã ã•ã„ã€‚
10ç§’ãã‚‰ã„ã§å®Œäº†ã—ã¾ã—ãŸã€‚
![](/images/20230819_020.png)
å®Œäº†ã—ãŸã‚‰ã€ãã®ã¾ã¾SDã‚«ãƒ¼ãƒ‰ã‚’æŠœã„ã¦OKã§ã™ã€‚

### RaspberryPiã‚’èµ·å‹•ã™ã‚‹
ä½œæˆã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ ssh ã‚’çµ„ã¿è¾¼ã‚“ã ã®ã§ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ç›´æŒ‡å®šï¼ˆã“ã“ã§ã¯192.168.1.10ã¨ã—ã¾ã™ï¼‰ã§æ¥ç¶šã—ã¾ã—ã‚‡ã†ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‹ã‚‰ãªã„æ™‚ã¯ã€ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’RaspberryPiã«æ¥ç¶šã—ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰ã€‚
Macå´ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ã€rootã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ¥ç¶šã—ã¦ãã ã•ã„ã€‚
```
ï¼„ ssh root@192.168.1.10
```

mqtt5_pubsub ã‚³ãƒãƒ³ãƒ‰ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ã€ç¢ºèªã—ã¾ã™ã€‚
```
# mqtt5_pubsub
Usage:
mqtt5-pubsub --ca_file <path> --cert <path> --client_id <str> --count <int> --endpoint <str> --help  --is_ci <str> --key <path> --log_file <str> --message <str> --port_override <int> --proxy_host <str> --proxy_port <int> --topic <str> --verbosity <log level>

....
```
Usageãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒãƒ³ãƒ‰ãŒã¡ã‚ƒã‚“ã¨çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

## AWS ã‚¯ãƒ©ã‚¦ãƒ‰å´ã‚’æº–å‚™ã™ã‚‹
### AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³
[AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://aws.amazon.com/jp/console/)ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
![](/images/20230611_110.png)
ã‚‚ã—ã€AWSã‚’åˆã‚ã¦è§¦ã‚‹æ–¹ã¯ã€ä»¥ä¸‹ã‚ãŸã‚Šã‚’å‚è€ƒã«ã€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
[åˆã‚ã¦ã®AWSãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã‹ï¼Ÿ](https://docs.aws.amazon.com/ja_jp/accounts/latest/reference/welcome-first-time-user.html)

### IoT Core ã«å…¥ã‚‹
ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚‰ä¸Šéƒ¨ã«ã‚ã‚‹æ¤œç´¢æ¬„ã«ã€â€IoT"ã‚’å…¥åŠ›ã—ã¦ã€â€IoT Core"ã‚’é¸æŠã—ã¾ã™ã€‚
![](/images/20230611_120.png)
### ãƒ‡ãƒã‚¤ã‚¹ã‚’ä½œæˆã™ã‚‹
AWS IoT ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚
å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚ã‚‹ã€Œï¼‘å€‹ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¥ç¶šã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
![](/images/20230611_130.png)
Step1,2,3,4 ã®æ‰‹é †ã«å¾“ã£ã¦ã€AWSã¨RaspberryPiã‚’è¨­å®šã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
![](/images/20230611_150.png)
#### Step1. ãƒ‡ãƒã‚¤ã‚¹ã‚’æº–å‚™ã™ã‚‹
ä¸Šã‹ã‚‰é †ã«èª­ã‚“ã§ã„ãã¨ã€ã€ã€
![](/images/20230611_160.png)
ã€Œã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¾ã™ã€ã¨ã„ã†ã¨ã“ã‚ã§ã€
pingã‚³ãƒãƒ³ãƒ‰ãŒè¨˜è¼‰ã—ã¦ã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ã€RaspberryPiã‹ã‚‰ã€AWSã®ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã‚‹ã®ã‹ã€ã‚’ç¢ºèªã—ã¦ã­ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚
&nbsp;
ã§ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€RaspberryPiã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ã€å®Ÿè¡Œã—ã¾ã™ã€‚
```
pi@raspberrypi2:~ $ ping aqxxxx.ap-northeast-1.amazonaws.com
PING aqxxxx.ap-northeast-1.amazonaws.com(2400:.... (2400:...)) 56 data bytes
64 bytes from 2400:... (2400:...): icmp_seq=1 ttl=250 time=5.30 ms
64 bytes from 2400:... (2400:...): icmp_seq=1 ttl=250 time=5.13 ms
^C
```
æˆåŠŸã—ã¾ã—ãŸã€‚
RaspberryPiã‹ã‚‰AWSã¾ã§ã®é€šä¿¡ãŒã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
#### Step2. ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¦ä¿è­·ã™ã‚‹
IoTãƒ‡ãƒã‚¤ã‚¹ã¨ã—ã¦ã€æ–°ã—ã„ãƒ¢ãƒ(Thing)ã‚’ä½œæˆã—ã¾ã™ã€‚
åå‰ã¯ã€"raspi2-test"ã¨ã—ã¾ã™ã€‚
![](/images/20230819_110.png)
#### Step3. ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨SDKã‚’é¸æŠã—ã¾ã™
RaspberryPiã®OSã¨ã€çµ„ã¿è¾¼ã‚€SDKã®ç¨®é¡ã‚’é¸æŠã—ã¾ã™ã€‚
ã“ã“ã§ã¯ã€Linux/macOS, Pythonã‚’é¸ã³ã¾ã™ã€‚
![](/images/20230611_180.png)
#### Step4. æ¥ç¶šã‚­ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
æ¥ç¶šã‚­ãƒƒãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
![](/images/20230819_130.png)

#### Step5. æ¥ç¶šã‚­ãƒƒãƒˆã‚’å®Ÿè¡Œ
ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ç”»é¢ã«ãªã‚Šã¾ã™ã€‚
start.sh ã®èª¬æ˜ã¯ç„¡è¦–ã—ã¦ã€ã€Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ sdk/test/pythonã€éƒ¨åˆ†ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã™ã€‚
![](/images/20230819_140.png)
AWSå´ã®è¨­å®šã¯ä¸€æ—¦ã“ã‚Œã§çµ‚äº†ã§ã™ã€‚

#### Step6. AWSã®ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
å…¬å¼æ‰‹é †ã«ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã“ã§AWSãŒå…¬é–‹æŒ‡å®šã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
Macä¸Šã§æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®curlã‚³ãƒãƒ³ãƒ‰ã§ "ca-certificates.crt"ã¨ã„ã†åå‰ã§ä¿å­˜ã—ã¾ã™ã€‚
ã‚ã¨ã§èª¬æ˜ã—ã¾ã™ãŒã€å¿…ãšã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã§ä¿å­˜ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚
```
$ curl https://www.amazontrust.com/repository/AmazonRootCA1.pem > ca-certificates.crt
```

## RaspberryPiã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã€‚
Step4, Step6 ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸZIPãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸ã‚’ã€RaspberryPiã«æŒã£ã¦ã„ãã¾ã™ã€‚
Macä¸Šã§æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ã€/home/rootãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« scp ã—ã¾ã™ã€‚
```
$ scp connect_device_package.zip ca-certificates.crt root@192.168.1.10:/home/root
connect_device_package.zip             100% 6389   840.6KB/s   00:00    
ca-certificates.crt                    100% 1188   270.9KB/s   00:00 
```

&nbsp;
ç¶šã„ã¦ã€ssh ã§ã€RaspberryPiã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
```
$ ssh root@192.168.1.10
```

scpã—ãŸZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’/etc/ssl/certsãƒ•ã‚©ãƒ«ãƒ€ã§è§£å‡ã—ã¾ã™ã€‚
```
root@raspberrypi2:~# mkdir -p /etc/ssl/certs
root@raspberrypi2:~# cp connect_device_package.zip ca-certificates.crt /etc/ssl/certs
root@raspberrypi2:~# cd /etc/ssl/certs
root@raspberrypi2:/etc/ssl/certs# unzip connect_device_package.zip 
Archive:  connect_device_package.zip
  inflating: raspi2-test.cert.pem
  inflating: raspi2-test.public.key
  inflating: raspi2-test.private.key
  inflating: raspi2-test-Policy
  inflating: start.sh
```

MQTT5ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ãƒ˜ãƒ«ãƒ—ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
mqtt5_pubsub  --endpoint <endpoint> --cert <path to the certificate> --key <path to the private key> --topic <topic name>
```

ã“ã“ã§é‡è¦ãªã®ã¯ä»¥ä¸‹ã®ï¼–ã¤ã®æƒ…å ±ã§ã™ã€‚æ•´ç†ã—ã¾ã™ã€‚
|      | æƒ…å ± |
| ---- | ---- |
| ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸   | ca-certificates.crt |
| ãƒ‡ãƒã‚¤ã‚¹è¨¼æ˜æ›¸   | raspi2-test.cert.pem |
| ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ | raspi2-test.private.key |
| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | aqxxxx-ats.iot.ap-northeast-1.amazonaws.com  |
| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID | basicPubSub |
| ãƒˆãƒ”ãƒƒã‚¯ | sdk/test/python |

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ãƒˆãƒ”ãƒƒã‚¯ ã¯ã€start.sh ã®æœ€çµ‚è¡Œã«è¨˜è¼‰ã—ã¦ã‚ã‚Šã¾ã™ã€‚

MQTT5ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å‚è€ƒã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ã¾ã™ã€‚
å¾Œè¿°ã—ã¾ã™ãŒã€ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã«ã—ã¦ã‚ã‚Šã¾ã™ã®ã§ã€æŒ‡å®šä¸è¦ã§ã™ã€‚
```
root@raspberrypi2:/etc/ssl/certs# mqtt5_pubsub --endpoint aqxxxx-ats.iot.ap-northeast-1.amazonaws.com --cert raspi2-test.cert.pem --key raspi2-test.private.key --client_id basicPubSub --topic sdk/test/python
Mqtt5 Client attempting connection...
Mqtt5 Client connection succeed, clientid: basicPubSub.
Subscription Success.
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 1"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 2"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 3"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 4"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 5"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 6"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 7"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 8"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 9"
Publish Succeed.
Publish received on topic sdk/test/python:"Hello World 10"
Mqtt5 Client disconnection with reason: libaws-c-mqtt: AWS_ERROR_MQTT5_USER_REQUESTED_STOP, Mqtt5 client connection interrupted by user request..
Mqtt5 Client stopped.
```
ï¼‘ç§’æ¯ã«10å›ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã—ãŸã€‚
æœ€å¾Œã€AWS_ERROR_MQTT5_USER_REQUESTED_STOP ã¨ã„ã†è¡¨ç¤ºãŒå‡ºã¦ã„ã¾ã™ãŒã€
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒãƒ³ãƒ‰ã¯ç‰¹ã«æŒ‡å®šã—ãªã‘ã‚Œã°ã€10å›ã‚³ãƒãƒ³ãƒ‰ã‚’æŠ•ã’ã¦çµ‚äº†ã™ã‚‹ã®ã§ã€æ°—ã«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

AWSå´ã®è¨­å®šãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
![](/images/20230819_150.png)
Hello worldãŒ10å›è¡¨ç¤ºã•ã‚Œã¦ã¾ã™ï¼


æ¬¡ã¯ã€ä»»æ„ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã“ã“ã§ã¯ã€"I am RaspberryPi"ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’1å›ã ã‘ã€é€ã£ã¦ã¿ã¾ã™ã€‚ 
--count, --message ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒãƒ³ãƒ‰ã®æœ€å¾Œã«ä»˜ä¸ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚
```
root@raspberrypi2:/etc/ssl/certs# mqtt5_pubsub --endpoint aqxxxx-ats.iot.ap-northeast-1.amazonaws.com --cert raspi2-test.cert.pem --key raspi2-test.private.key --client_id basicPubSub --topic sdk/test/python --count 1 --message "I am RaspberryPi "
```

AWSå´ã®è¨­å®šãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
![](/images/20230819_160.png)
ã‚„ã‚Šã¾ã—ãŸã€‚æŒ‡å®šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’AWS IoTå´ã«é€ã‚‹äº‹ãŒã§ãã¾ã—ãŸï¼

ä»Šå›ã¯ã€meta-awsã®ãƒ¬ã‚·ãƒ”ã‚’ä½¿ã£ã¦ã€RaspberryPiå‘ã‘ã®C++SDKã‚’çµ„ã¿è¾¼ã‚“ã§ã€
AWS IoT Coreã¸MQTTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã‚‹ã¨ã“ã‚ã¾ã§ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚


ä»¥ä¸‹ã¯ã€ä»Šå›ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã™ã€‚èˆˆå‘³ã‚ã‚‹æ–¹ã¯ã”è¦§ãã ã•ã„ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
mqtt5_pubsub ã‚³ãƒãƒ³ãƒ‰ã§ã™ãŒã€AWSã‚¯ãƒ©ã‚¦ãƒ‰å´ãŒæº–å‚™ã§ãã¦ã„ãªã‹ã£ãŸã‚Šã€æ­£ã—ãã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãªã„ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
```
root@raspberrypi2:/home/root# mqtt5_pubsub --endpoint aqxxxx-ats.iot.ap-northeast-1.amazonaws.com --ca_file ca-certificates.crt --cert test0817-2.cert.pem --key test0817-2.private.key --client_id basicPubSub --topic sdk/test/python
Failed to Init Mqtt5Client with error code 1173: 
aws-c-io: AWS_IO_TLS_ERROR_DEFAULT_TRUST_STORE_NOT_FOUND, 
Default TLS trust store not found on this system. 
Trusted CA certificates must be installed, or 
"override default trust store" must be used while creating the TLS context.
```
ä»Šå›ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã©ãƒãƒã‚Šã—ã¦ã—ã¾ã£ãŸã®ã§ã€ä»¥ä¸‹ã«ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

### ï¼‘ï¼‰ AWS_IO_TLS_ERROR_DEFAULT_TRUST_STORE_NOT_FOUND
#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Failed to Init Mqtt5Client with error code 1173: 
aws-c-io: AWS_IO_TLS_ERROR_DEFAULT_TRUST_STORE_NOT_FOUND, 
Default TLS trust store not found on this system. 
Trusted CA certificates must be installed, or 
"override default trust store" must be used while creating the TLS context.
```
#### åŸå› 
ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸ã€ã“ã“ã§ã¯AWSã®ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸ã‚’èª­ã¿è¾¼ã‚ãªã‹ã£ãŸã€‚
#### å¯¾ç­–
è¨¼æ˜æ›¸ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ã«ç½®ãã‹ã€å¼•æ•°ã§è¨¼æ˜æ›¸ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
mqtt5_pubsubã‚³ãƒãƒ³ãƒ‰ã¯ "--ca_file" ã§ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸ã‚’æŒ‡å®šã§ãã¾ã™ãŒã€2023âˆ’08âˆ’19æ™‚ç‚¹ã§ã¯ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æŒ‡å®šã‚’èªè­˜ã—ã¾ã›ã‚“ã§ã—ãŸã€‚
ä»¥ä¸‹ã‚’è¦‹ã‚‹ã¨ã€æœ€æ–°ã®ca-certificates packageã‚’ä½¿ãˆã°æŒ‡å®šã§ãã‚‹ã£ã½ã„ã§ã™ï¼ˆé–“é•ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒï¼‰ã€‚
[TLS configuration with AWS CRT client](https://github.com/aws/aws-sdk-java-v2/discussions/3898#discussioncomment-5612167)
ãŸã ã€Yoctoã§çµ„ã¿è¾¼ã‚“ã§ã„ã‚‹ca-certificates packageã¯ã€poky/meta/receipes-support/ca-certificates/ca-certificates_20211016.bb ã¨ã„ã†é¢¨ã«2021å¹´ã‚‚ã®ãªã®ã§ã€ã“ã‚Œã‚’æœ€æ–°ã«ã™ã‚‹ã®ã¯é¢å€’ãªï¼ˆæ°—ãŒã—ãŸï¼‰ã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ã«è¨¼æ˜æ›¸ã‚’ç½®ãã‚ˆã†ã«ã—ã¾ã™ã€‚
é•ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã—ãŸã‚‰ã€ã”æŒ‡æ‘˜ãã ã•ã„ã€‚

ã§ã™ãŒã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒç¤ºã™ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãŒã©ã“ã‹ã¯è¨˜è¼‰ã•ã‚Œã¦ã„ãªã„ã®ã§ [aws-c-io](https://github.com/awslabs/aws-c-io/)ã®ä¸­ã‚’ AWS_IO_TLS_ERROR_DEFAULT_TRUST_STORE_NOT_FOUND ã‚’é ¼ã‚Šã«èª¿ã¹ã‚‹ã¨ [ã“ã“](https://github.com/awslabs/aws-c-io/blob/c4b661f44497b18201b56ffd200cc478441f6434/source/s2n/s2n_tls_channel_handler.c#L136C1-L136C31)ã«ã‚ã‚Šã¾ã—ãŸã€‚
è¤‡æ•°ã®å®šç¾©ã¯ã‚ã‚Šã¾ã—ãŸãŒã€é †ç•ªã«è¦‹ã‚‹ã‚ˆã†ãªã®ã§æœ€åˆã®debianã®ãƒ‘ã‚¹ã«ç½®ãã“ã¨ã«ã—ã¾ã™ã€‚
```
/etc/ssl/certs/ca-certificates.crt
```
ã“ã®ãŸã‚ã€æœ¬ç« ã§ã¯ "--ca_file"ã§ã®æŒ‡å®šã¯ã›ãšã«ã€AWSã®ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸ã‚’ä»¥ä¸‹ã«ç½®ãã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

### 2ï¼‰ AWS_ERROR_FILE_INVALID_PATH
#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Failed to setup mqtt5 client builder with error code 44: 
aws-c-common: AWS_ERROR_FILE_INVALID_PATH, Invalid file path.
```
#### åŸå› 
æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒè¦‹å½“ãŸã‚‰ãªã„ã€‚
ã“ã“ã§ã¯ã€ãƒ‡ãƒã‚¤ã‚¹è¨¼æ˜æ›¸ã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒã‚ã‹ã‚‰ãªã‹ã£ãŸã€‚
#### å¯¾ç­–
mqtt5_pubsubã® "--cert", "--key"ã§æŒ‡å®šã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ãã‹ã€ãƒ•ãƒ«ãƒ‘ã‚¹ã§æŒ‡å®šã™ã‚‹ã‹ã—ã¦ãã ã•ã„ã€‚
æœ¬ç« ã§ã¯ã€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã„ã¦ã„ã‚‹ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

### 3ï¼‰ AWS_IO_TLS_ERROR_NEGOTIATION_FAILURE
#### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```
Mqtt5 Client connection failed with error: 
aws-c-io: AWS_IO_TLS_ERROR_NEGOTIATION_FAILURE, TLS (SSL) negotiation failed.
```
#### åŸå› 
ä¸€ç•ªãƒãƒã£ãŸã®ãŒã“ã®å•é¡Œã§ã—ãŸã€‚
æš—å·åŒ–é€šä¿¡ï¼ˆTLSï¼‰æ¥ç¶šæ™‚ã®ãƒã‚´ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã§ã¯åŸå› ã¯ã‚ã‹ã‚‰ãªã„ã®ã§ã€opensslã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦èª¿ã¹ã‚‹äº‹ãŒã§ãã¾ã™ã€‚
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å•é¡Œãªã®ã‹ã€è¨¼æ˜æ›¸ã®å•é¡Œãªã®ã‹ã€è‰²ã€…ã¨åŸå› ãŒã‚ã‚‹ã®ã§ã™ãŒã€ä»Šå›ã¯ã€RaspberryPiã®ç¾åœ¨æ™‚åˆ»ãŒåˆã£ã¦ã„ãªã„ï¼ˆæ˜”ã®æ™‚åˆ»ã«ãªã£ã¦ã„ã‚‹ï¼‰ã¨ã„ã†ã®ãŒåŸå› ã§ã—ãŸã€‚
#### å¯¾ç­–
RaspberryPiã®ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»ã‚’åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
UTCæ™‚åˆ»ã§è¨­å®šã—ã¾ã™ã€‚PCã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚åˆ»ã‹ã‚‰9æ™‚é–“å¼•ã„ãŸæ™‚åˆ»ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
```
# date -s "2023-08-16 14:31:00"
```
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯Linuxä¸Šã®æ™‚åˆ»ã‚’æ›´æ–°ã™ã‚‹ã ã‘ã§ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢å´ã€RTC(Real Time Clock)ã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
ä¸€èˆ¬çš„ã«ã¯ã€RTCã¯ãƒœã‚¿ãƒ³é›»æ± ãªã©ã§é§†å‹•ã—ã€å¸¸æ™‚æ™‚åˆ»æƒ…å ±ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚Linuxã¯èµ·å‹•æ™‚ã«RTCã‹ã‚‰ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã—ã€ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã‚„å†èµ·å‹•æ™‚ã«RTCã«æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ¬¡å›èµ·å‹•ã—ãŸæ™‚ã«ã€ãã“ãã“æ­£ã—ã„æ™‚åˆ»ã§èµ·å‹•ã§ãã‚‹ã€ã¨ã„ã†æµã‚Œã«ãªã£ã¦ã„ã¾ã™ã€‚
æ‰‹å‹•ã§Linuxã®æ™‚åˆ»ã¨RTCã‚’åŒæœŸã™ã‚‹ã«ã¯ã€hwclockã‚³ãƒãƒ³ãƒ‰ãªã©ã‚’ä½¿ç”¨ã—ã¾ã™ãŒã€æ®‹å¿µãªãŒã‚‰RaspberryPiã¯RTCã‚’æ­è¼‰ã—ã¦ãªã„ã®ã§ã€ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
æ’ä¹…å¯¾ç­–ã¨ã—ã¦ã¯ã€RTCã‚’æ­è¼‰ã™ã‚‹ã¨ã‹ã€NTPã‚‚çµ„ã¿è¾¼ã‚“ã§èµ·å‹•æ™‚ã«NTPã‚µãƒ¼ãƒãƒ¼ã¨æ™‚åˆ»ã‚’åŒæœŸã™ã‚‹ã€ãªã©ãŒã‚ã‚Šã¾ã™ã€‚

opensslã‚³ãƒãƒ³ãƒ‰ã§ã®èª¿æŸ»ã§ã™ãŒã€ã“ã¡ã‚‰ã‚‚ä¸€æ‰‹é–“ã‹ã‹ã£ãŸã®ã§ã€ã„ã‹ã«è¨˜è¼‰ã—ã¦ãŠãã¾ã™ã€‚

#### OpenSSLã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹TLSæ¥ç¶šã‚¨ãƒ©ãƒ¼èª¿æŸ»
aws-c-ioã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ã§ã™ãŒã€æ¥ç¶šå‡¦ç†è‡ªä½“ã¯RaspberryPiã«çµ„ã¿è¾¼ã‚“ã§ã„ã‚‹OpenSSLã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ã“ã®ãŸã‚ã€opensslã‚³ãƒãƒ³ãƒ‰ã§èª¿æŸ»ã§ãã¾ã™ã€‚
[AWSãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/ja_jp/iot/latest/developerguide/diagnosing-connectivity-issues.html)

ãŸã ã€ã€ã€
```
root@raspberrypi2:~# openssl
-sh: openssl: not found
```
ä»Šå›ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€opensslã‚³ãƒãƒ³ãƒ‰æœ¬ä½“ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ãªã®ã§ã€opensslã‚³ãƒãƒ³ãƒ‰ã‚’çµ„ã¿è¾¼ã‚€ã¨ã„ã†æµã‚Œã«ãªã‚Šã¾ã™ã€‚
ä¾‹ãˆã°ã€bitbakeã‚³ãƒãƒ³ãƒ‰ã§ core-image-minimal ä»¥å¤–ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã€è‡ªåˆ†ã§ãƒ¬ã‚·ãƒ”ã‚’è¿½åŠ ã™ã‚‹ã¨ã„ã†ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã¯ã€é¢å€’ãªã®ã§æœ€ä½é™ã®ãƒã‚¤ãƒŠãƒªã ã‘RaspberryPiã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚
ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨é€”ãªã‚“ã§è¨±ã—ã¦ãã ã•ã„ãƒ»ãƒ»ãƒ»ï¼‰

opensslã ã‘å†ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
```
$ bitbake -c cleansstate openssl
$ bitbake core-image-minimal
```

ä»¥ä¸‹ãŒopensslæœ¬ä½“ã§ã™ã€‚fileã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ã¾ã™ã€‚
```
ï¼„ file tmp/work/cortexa7t2hf-neon-vfpv4-poky-linux-gnueabi/openssl/3.1.1-r0/package/usr/bin/openssl 
tmp/work/cortexa7t2hf-neon-vfpv4-poky-linux-gnueabi/openssl/3.1.1-r0/package/usr/bin/openssl: ELF 32-bit LSB pie executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-armhf.so.3, BuildID[sha1]=b43cf377ca6fad3d6bd5455382ca638ed66eb19d, for GNU/Linux 5.15.0, stripped
```

ç¶šã„ã¦ã€openssl, libssl.so.3 ã®2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€docker cpã¨scpã‚³ãƒãƒ³ãƒ‰ã§RaspberryPiã«æŒã£ã¦ã„ãã¾ã™ã€‚
ãƒ‡ãƒãƒƒã‚°ç”¨é€”ãªã®ã§ã€/home/rootã«ä¿å­˜ã—ã¾ã™ã€‚
```
$ docker cp b7c4cb3eeb5c:/home/hoge/raspi2/poky/build/tmp/work/cortexa7t2hf-neon-vfpv4-poky-linux-gnueabi/openssl/3.1.1-r0/package/usr/bin/openssl .
$ docker cp b7c4cb3eeb5c:/home/hoge/raspi2/poky/build/tmp/work/cortexa7t2hf-neon-vfpv4-poky-linux-gnueabi/openssl/3.1.1-r0/package/usr/lib/libssl.so.3 .
$
$ scp openssl libssl.so.3 root@192.168.1.10:/home/root
```

opensslã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚
æ™®é€šã«å®Ÿè¡Œã™ã‚‹ã¨libssl.soã‚’èª­ã¿è¾¼ã‚ãªã„ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‘ã‚¹ã‚’LD_LIBRARY_PATHå¤‰æ•°ã§æŒ‡å®šã—ã¾ã™ã€‚
```
root@raspberrypi2:~# chmod +x /home/root/openssl
root@raspberrypi2:~# LD_LIBRARY_PATH=/home/root /home/root/openssl version
OpenSSL 3.1.1 30 May 2023 (Library: OpenSSL 3.1.1 30 May 2023)
```
ã¨ã„ã†ã“ã¨ã§ã€ç„¡ç†çŸ¢ç†ã§ã™ãŒã€opensslã‚³ãƒãƒ³ãƒ‰ç„¡äº‹å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã§ã¯ã€openssl s_clientã‚³ãƒãƒ³ãƒ‰ã§ AWSã¨ã®æ¥ç¶šã‚’ç¢ºèªã—ã¾ã™ã€‚
```
root@raspberrypi2:~# cd /etc/ssl/certs
root@raspberrypi2:/etc/ssl/certs# LD_LIBRARY_PATH=/home/root /home/root/openssl s_client -connect aqxxxx-ats.iot.ap-northeast-1.amazonaws.com:8443 -CAfile ca-certificates.crt -cert raspi2-test.cert.pem -key raspi2-test.private.key 
CONNECTED(00000003)
depth=2 C = US, O = Amazon, CN = Amazon Root CA 1
verify return:1
.
.
.
New, TLSv1.3, Cipher is TLS_AES_128_GCM_SHA256
Server public key is 2048 bit
This TLS version forbids renegotiation.
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 9 (certificate is not yet valid)
```
Verify return code: 0 ä»¥å¤–ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
Verify return code: 9 ã‚’æ¤œç´¢ã™ã‚‹ã¨ã€ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»ãŒå¤ã„ãã¦è¨¼æ˜æ›¸ãŒã¾ã æœ‰åŠ¹ã§ãªã„ã€ã¨ã„ã†æ„å‘³ã«ãªã‚‹ã€ã¨ã®ã“ã¨ã§ã™ã€‚

ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®šã—ã¾ã™ã€‚
```
root@raspberrypi2:/etc/ssl/certs# date -s "2023-08-20 6:09"
```

å†åº¦ã€opensslã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```
root@raspberrypi2:/etc/ssl/certs# LD_LIBRARY_PATH=/home/root /home/root/openssl s_client -connect aqxxxx-ats.iot.ap-northeast-1.amazonaws.com:8443 -CAfile ca-certificates.crt -cert raspi2-test.cert.pem -key raspi2-test.private.key 
CONNECTED(00000003)
depth=2 C = US, O = Amazon, CN = Amazon Root CA 1
verify return:1
.
.
.
New, TLSv1.3, Cipher is TLS_AES_128_GCM_SHA256
Server public key is 2048 bit
This TLS version forbids renegotiation.
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 0 (ok)
---
```
æœ€çµ‚è¡Œã®return code: 0(ok)ã¨ãªã‚Šã€ç„¡äº‹AWSå´ã¨æ¥ç¶šã§ããŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

## ã¾ã¨ã‚
ä»Šå›ã¯ã€meta-awsã®ãƒ¬ã‚·ãƒ”ã‚’ä½¿ã£ã¦ã€RaspberryPiå‘ã‘ã®C++SDKã‚’çµ„ã¿è¾¼ã‚“ã§ã€
AWS IoT Coreã¸MQTTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã‚‹ã¨ã“ã‚ã¾ã§ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
æ¬¡å›ã¯ã€AWSã€€IoTã€€Coreã‚’ãã¡ã‚“ã¨è¨­å®šã—ã¦ã€MQTTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ç¢ºèªã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## å‚ç…§
AWS IoT ã«ãŠã‘ã‚‹ãƒ‡ãƒãƒƒã‚°æ–¹æ³•
https://pages.awscloud.com/rs/112-TZM-766/images/EV_aws-iot-deep-dive-3-310-topic1_Mar-2021.pdf

